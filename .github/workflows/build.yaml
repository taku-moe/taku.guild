name: Build

on: [push, pull_request]

jobs:
  compile:
    name: Compile Typescript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependancies
        run: "npm i"
      - name: Compile Typescript
        run: "tsc"
      - name: Upload compiled JS
        uses: actions/upload-artifact@v2
        with:
          name: Compiled Typescript
          path: dist

  compile_linux:
    name: "Compile for Linux"
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependancies
        run: "npm i"
      - name: Download compiled JS
        uses: actions/download-artifact@v2
        with:
          name: Compiled Typescript
          path: dist
      - name: "Compile for Linux"
        run: "npm run compile-linux"
      - name: Upload compiled JS
        uses: actions/upload-artifact@v2
        with:
          name: Taku Server Linux
          path: build
  compile_macos:
    name: "Compile for MacOS"
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependancies
        run: "npm i"
      - name: Download compiled JS
        uses: actions/download-artifact@v2
        with:
          name: Compiled Typescript
          path: dist
      - name: "Compile for MacOS"
        run: "npm run compile-macos"
      - name: Upload compiled JS
        uses: actions/upload-artifact@v2
        with:
          name: Taku Server MacOS
          path: build
  compile_win:
    name: "Compile for Windows"
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependancies
        run: "npm i"
      - name: Download compiled JS
        uses: actions/download-artifact@v2
        with:
          name: Compiled Typescript
          path: dist
      - name: "Compile for Windows"
        run: "npm run compile-win"
      - name: Upload compiled JS
        uses: actions/upload-artifact@v2
        with:
          name: Taku Server Windows
          path: build

  test_win:
    name: "Test Windows Build"
    runs-on: windows-latest
    needs: compile_win
    steps:
      - name: Download Windows Binary
        uses: actions/download-artifact@v2
        with:
          name: Taku Server Windows
          path: build
      - name: "Run Binary"
        run: "./build/taku.server.win.v%npm_package_version%.exe"

  test_linux:
    name: "Test Linux Build"
    runs-on: ubuntu-latest
    needs: compile_linux
    steps:
      - name: Download Linux Binary
        uses: actions/download-artifact@v2
        with:
          name: Taku Server Linux
          path: build
      - name: "Make runnable"
        run: "chmod +x ./build/taku.server.linux.v%npm_package_version%.bin"
      - name: "Run Binary"
        run: "sudo ./build/taku.server.linux.v%npm_package_version%.bin"

  test_macos:
    name: "Test MacOS Build"
    runs-on: macos-latest
    needs: compile_macos
    steps:
      - name: Download MacOS Binary
        uses: actions/download-artifact@v2
        with:
          name: Taku Server MacOS
          path: build
      - name: "Make runnable"
        run: "chmod +x ./build/taku.server.macos.v%npm_package_version%"
      - name: "Run Binary"
        run: "sudo ./build/taku.server.macos.v%npm_package_version%"